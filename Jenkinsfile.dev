pipeline {
    agent any
    
    environment {
        APP_NAME = 'fast-react-pizza'
        BUILD_TAG = "dev-${env.BUILD_NUMBER}"
        DOCKER_IMAGE = "${APP_NAME}-${BUILD_TAG}"
        CONTAINER_NAME = "${APP_NAME}-${BUILD_TAG}"
        PORT = '3001'
    }
    
    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo '========== STAGE 1: CHECKOUT =========='
                checkout scm
                bat '''
                    echo âœ… Checked out branch
                    git branch
                    git log -1 --oneline
                '''
            }
        }
        
        stage('âš™ï¸ Setup') {
            steps {
                echo '========== STAGE 2: SETUP =========='
                bat '''
                    node --version
                    npm --version
                    docker --version
                '''
            }
        }
        
        stage('ğŸ”¨ Build Application') {
            steps {
                echo '========== STAGE 3: BUILD APPLICATION =========='
                bat '''
                    echo ğŸ“¦ Installing dependencies...
                    call npm ci
                    echo âœ… Dependencies installed
                    
                    echo ğŸ”¨ Building Next.js static export...
                    call npm run build:static
                    echo âœ… Build completed
                '''
            }
        }
        
        stage('ğŸ³ Docker Build') {
            steps {
                echo '========== STAGE 4: DOCKER BUILD =========='
                bat '''
                    echo ğŸ³ Building Docker image: %DOCKER_IMAGE%
                    docker build -t %DOCKER_IMAGE% .
                    echo âœ… Docker image built
                    docker images | findstr %APP_NAME%
                '''
            }
        }
        
        stage('ğŸš€ Run Container') {
            steps {
                echo '========== STAGE 5: RUN CONTAINER =========='
                bat '''
                    REM Cleanup old container if exists
                    docker rm -f %CONTAINER_NAME% 2>nul || echo No existing container
                    
                    REM Run new container
                    docker run -d --name %CONTAINER_NAME% -p %PORT%:80 %DOCKER_IMAGE%
                    
                    REM Wait 10 seconds for Nginx to start
                    ping 127.0.0.1 -n 11 >nul
                    
                    REM Verify container is running
                    docker ps | findstr %CONTAINER_NAME%
                '''
            }
        }
        
        stage('ğŸ”¥ Smoke Tests') {
            steps {
                echo '========== STAGE 6: SMOKE TESTS =========='
                bat '''
                    echo ğŸ§ª Testing application at http://localhost:%PORT%
                    curl -f http://localhost:%PORT%/health || exit /b 1
                    curl -f http://localhost:%PORT%/ || exit /b 1
                    echo âœ… Smoke tests PASSED
                '''
            }
        }
        
        stage('ğŸ“¦ Archive Artifacts') {
            steps {
                echo '========== STAGE 7: ARCHIVE ARTIFACTS =========='
                bat '''
                    if not exist artifacts mkdir artifacts
                    echo Dev Build Report > artifacts\\dev-build-report.log
                    echo Build Number: %BUILD_NUMBER% >> artifacts\\dev-build-report.log
                    echo Docker Image: %DOCKER_IMAGE% >> artifacts\\dev-build-report.log
                    echo Status: Success >> artifacts\\dev-build-report.log
                    
                    docker logs %CONTAINER_NAME% > artifacts\\container-logs.txt 2>&1
                '''
                archiveArtifacts artifacts: 'artifacts/*', allowEmptyArchive: false
            }
        }
        
        stage('ğŸ§¹ Cleanup') {
            steps {
                echo '========== STAGE 8: CLEANUP =========='
                bat '''
                    docker stop %CONTAINER_NAME% 2>nul || echo Container already stopped
                    docker rm %CONTAINER_NAME% 2>nul || echo Container already removed
                    docker rmi %DOCKER_IMAGE% 2>nul || echo Image already removed
                    echo âœ… Cleanup complete
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ…âœ…âœ… DEV PIPELINE PASSED âœ…âœ…âœ…'
        }
        failure {
            echo 'âŒâŒâŒ DEV PIPELINE FAILED âŒâŒâŒ'
        }
        always {
            cleanWs()
        }
    }
}
